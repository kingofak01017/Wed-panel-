<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Devices Live with Permanent Serials</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --primary: #2563eb;
  --primary-light: #dbeafe;
  --primary-dark: #1d4ed8;
  --primary-gradient: linear-gradient(135deg, #2563eb, #3b82f6);
  
  --success: #10b981;
  --success-dark: #059669;
  --danger: #ef4444;
  --danger-dark: #dc2626;
  --warning: #f59e0b;
  --like-color: #ec4899;
  --like-dark: #db2777;
  
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;
  
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
  
  --radius: 10px;
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  
  --transition: all 0.2s ease;
  --transition-medium: all 0.3s ease;
}

body {
  font-family: 'Inter', sans-serif;
  background: #f8fafc;
  color: var(--gray-800);
  min-height: 100vh;
  padding-bottom: 20px;
}

/* LOADER */
.fullscreen-loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 0.5s ease, visibility 0.5s ease;
  z-index: 9999;
}

.fullscreen-loader.hidden {
  opacity: 0;
  visibility: hidden;
}

.loader {
  position: relative;
  width: 100px;
  height: 100px;
  margin: 0 auto 25px;
}

.loader-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  animation: rotate 2s linear infinite;
}

.loader-ring {
  position: absolute;
  width: 100%;
  height: 100%;
  border-radius: 50%;
}

.loader-ring:nth-child(1) {
  border: 8px solid transparent;
  border-top: 6px solid rgb(0, 68, 255);
  border-right:6px solid rgb(0, 68, 255);
  animation: spin1 1.5s ease-in-out infinite alternate;
}

.loader-ring:nth-child(2) {
  border: 7px solid transparent;
  border-bottom: 6px solid rgb(0, 68, 255);
  border-left: 6px solid rgb(0, 68, 255);
  top: 15%;
  left: 15%;
  width: 70%;
  height: 70%;
  animation: spin2 2s ease-in-out infinite alternate;
}

.loader-ring:nth-child(3) {
  border: 6px solid transparent;
  border-top: 6px solid rgb(0, 68, 255);
  border-right:6px solid rgb(0, 68, 255);
  top: 25%;
  left: 25%;
  width: 50%;
  height: 50%;
  animation: spin3 2.5s ease-in-out infinite alternate;
}

.loader-core {
  position: absolute;
  top: 40%;
  left: 40%;
  width: 20%;
  height: 20%;
  background: rgb(0, 68, 255);
  border-radius: 50%;
  animation: pulse-core 1.5s ease-in-out infinite alternate;
}

@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes spin1 {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(720deg); }
}

@keyframes spin2 {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(-720deg); }
}

@keyframes spin3 {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pulse-core {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.8; }
}

.loading-text {
  color: rgb(5, 5, 5);
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 20px;
}

/* AUTH ERROR */
.auth-error {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 40px !important;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  text-align: center;
  max-width: 500px;
  width: 90%;
  z-index: 9999;
  border: 4px solid var(--danger);
  display: none;
}

.auth-error h2 {
  color: var(--danger);
  font-size: 24px !important;
  margin-bottom: 16px;
}

.auth-error p {
  font-size: 18px !important;
  color: var(--gray-600);
  margin-bottom: 25px;
}

.auth-error-btn {
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 16px 28px !important;
  border-radius: var(--radius-md);
  font-size: 18px !important;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin: 0 auto;
  transition: var(--transition);
}

.auth-error-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
}

.header {
  background: var(--primary-gradient);
  padding: 14px 20px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-md);
  border-bottom: 4px solid rgba(255, 255, 255, 0.2);
}

.header-inner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1200px;
  margin: 0 auto;
}

.header-title {
  font-size: 22px;
  font-weight: 800;
  color: white;
  display: flex;
  align-items: center;
  gap: 10px;
}

.live {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 20px;
  font-weight: 700;
  letter-spacing: 0.5px;
  border: 2px solid rgba(255, 255, 255, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.top-bar {
  display: flex;
  align-items: center;
  justify-content: flex-start;
}

.user-info {
  display: flex !important;
  flex-direction: row !important;
  align-items: center;
  gap: 12px;
  flex-wrap: nowrap !important;
  white-space: nowrap;
}

.device-count,
.active-badge {
  flex: 0 0 auto;
  cursor: pointer;
  user-select: none;
}

.device-count {
  font-weight: 600;
  color: rgba(255, 255, 255, 0.95);
  background: rgba(0, 0, 0, 0.4);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 12px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 120px;
  justify-content: center;
  transition: var(--transition);
}

.device-count:hover {
  background: rgba(0, 0, 0, 0.5);
  transform: translateY(-2px);
}

.device-count.active-filter {
  background: var(--primary-gradient);
  border-color: rgba(255, 255, 255, 0.5);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
}

.active-badge {
  background: rgba(0, 0, 0, 0.4);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 150px;
  justify-content: center;
  transition: var(--transition);
}

.active-badge:hover {
  background: rgba(0, 0, 0, 0.5);
  transform: translateY(-2px);
}

.active-badge.active {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
}

.active-badge.active-filter {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  border-color: rgba(255, 255, 255, 0.5);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.device-count span,
.active-count {
  font-weight: 800;
  font-size: 14px;
}

/* STATUS BAR */
.status-bar {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  padding: 6px 0;
  text-align: center;
  color: white;
  font-weight: 600;
  font-size: 12px;
  border-bottom: 2px solid rgba(0, 0, 0, 0.1);
}

.nav {
  background: white;
  border-bottom: 2px solid var(--gray-200);
  position: sticky;
  top: 62px;
  z-index: 99;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  padding: 6px 0;
}

.nav-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
}

.nav-links {
  display: flex;
  justify-content: center;
  gap: 6px;
  overflow-x: auto;
  padding: 4px 0;
}

.nav-links::-webkit-scrollbar {
  display: none;
}

.nav a {
  color: var(--gray-600);
  text-decoration: none;
  padding: 10px 18px;
  font-size: 14px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  border-radius: var(--radius-md);
  white-space: nowrap;
  transition: var(--transition);
  border: 2px solid transparent;
  background: var(--gray-100);
}

.nav a:hover {
  background: var(--primary-light);
  color: var(--primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.nav a.active {
  background: var(--primary-gradient);
  color: white;
  font-weight: 700;
  border-color: var(--primary-dark);
  box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
}

.search-bar {
  background: white;
  padding: 16px 20px;
  border-bottom: 2px solid var(--gray-200);
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  position: sticky;
  top: 104px;
  z-index: 98;
}

.search-container {
  position: relative;
  max-width: 800px;
  margin: 0 auto;
}

.search-bar input {
  width: 100%;
  padding: 12px 14px 12px 44px;
  border-radius: var(--radius-lg);
  border: 2px solid var(--gray-300);
  font-size: 14px;
  background: var(--gray-50);
  transition: var(--transition-medium);
  font-weight: 500;
}

.search-bar input:focus {
  outline: none;
  border-color: var(--primary);
  background: white;
  box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
}

.search-bar i {
  position: absolute;
  left: 16px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--primary);
  font-size: 15px;
}

.main {
  padding: 0 16px 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.devices {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.device-card {
  background: white;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: var(--transition-medium);
  border: 2px solid var(--gray-200);
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
  height: 160px;
  display: flex;
  flex-direction: column;
  padding-top: 4px;
}

.device-card:hover {
  transform: translateY(-3px);
  box-shadow: var(--shadow);
  border-color: var(--primary);
}

.device-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: var(--primary-gradient);
  z-index: 1;
}

.top-buttons-container {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
  z-index: 4;
}

.serial-badge {
  width: 40px;
  height: 40px;
  background: var(--primary-gradient);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 14px;
  box-shadow: 0 3px 8px rgba(37, 99, 235, 0.4);
  border: 2px solid white;
  flex-shrink: 0;
  cursor: default;
}

.serial-badge .serial-text {
  font-size: 16px;
  font-weight: 900;
}

.like-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
  font-size: 14px;
  background: white;
  color: var(--gray-600);
  border: 2px solid var(--gray-300);
}

.like-btn.liked {
  background: linear-gradient(135deg, var(--like-color), var(--like-dark));
  color: white;
  border: none;
  box-shadow: 0 3px 10px rgba(236, 72, 153, 0.5);
}

.like-btn:hover {
  transform: scale(1.1) translateY(-2px);
}

.delete-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
  font-size: 14px;
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
  color: white;
}

.delete-btn:hover {
  transform: scale(1.1) translateY(-2px);
  background: linear-gradient(135deg, var(--danger-dark), #b91c1c);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px 6px;
  flex: none;
}

.device-image {
  width: 34px;
  height: 34px;
  object-fit: contain;
  flex-shrink: 0;
  padding: 5px;
  border-radius: var(--radius-sm);
  background: white;
  border: 2px solid var(--gray-200);
}

.device-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.device-name-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  min-height: 20px;
}

.device-name {
  font-weight: 700;
  font-size: 13px;
  color: var(--primary-dark);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.3;
  flex: 1;
  min-width: 0;
}

.device-version {
  font-size: 11px;
  color: #ffffff;
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  padding: 3px 8px;
  margin-right: 110px;
  border-radius: 8px;
  font-weight: 700;
  border: 1px solid var(--primary-dark);
  white-space: nowrap;
  flex-shrink: 0;
}

.sim-info {
  background: var(--gray-50);
  padding: 6px 12px;
  border-radius: var(--radius-sm);
  margin: 0 14px 6px;
  border: 1px solid var(--gray-200);
  transition: var(--transition);
  flex: 1;
  min-height: 55px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.sim-info:hover {
  background: var(--primary-light);
  border-color: var(--primary);
}

.sim-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
}

.sim-header i {
  color: var(--primary);
  font-size: 12px;
  flex-shrink: 0;
}

.sim-details {
  flex: 1;
  min-width: 0;
}

.sim-number {
  font-weight: 600;
  color: var(--gray-800);
  font-size: 11px;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sim-carrier {
  font-size: 10px;
  color: var(--gray-500);
  margin-top: 2px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.time-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 6px;
  margin-top: 6px;
  padding-top: 6px;
  border-top: 1px dashed var(--gray-300);
}

.time-item {
  display: flex;
  align-items: flex-start;
  gap: 5px;
}

.time-item i {
  color: var(--primary);
  font-size: 10px;
  width: 12px;
  text-align: center;
  flex-shrink: 0;
  margin-top: 1px;
}

.time-text {
  font-size: 10px;
  color: var(--gray-700);
  line-height: 1.2;
}

.time-label {
  font-weight: 600;
  color: var(--gray-600);
  margin-right: 2px;
  display: inline-block;
  font-size: 9px;
}

.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 14px;
  background: var(--gray-50);
  border-top: 1px solid var(--gray-200);
  margin-top: auto;
  min-height: 38px;
}

.device-id {
  font-size: 10px;
  color: var(--gray-500);
  font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100px;
  background: white;
  padding: 5px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--gray-300);
  font-weight: 600;
  flex-shrink: 0;
}

.check-online-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 5px 12px;
  border-radius: var(--radius-sm);
  font-size: 11px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition-medium);
  border: 1px solid var(--primary-dark);
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 105px;
  justify-content: center;
}

.check-online-btn:hover:not(.checking):not(:disabled) {
  background: linear-gradient(135deg, #1d4ed8, #2563eb);
  transform: translateY(-1px);
}

.check-online-btn.checking {
  background: linear-gradient(135deg, var(--warning), #d97706);
  cursor: not-allowed;
  border-color: #d97706;
  padding: 5px 10px;
  min-width: 105px;
}

.check-online-btn.online {
  background: linear-gradient(135deg, var(--success), var(--success-dark));
  border-color: var(--success-dark);
  padding: 5px 12px;
  min-width: 80px;
}

.check-online-btn.offline {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
  border-color: var(--danger-dark);
  padding: 5px 12px;
  min-width: 80px;
}

.empty {
  text-align: center;
  padding: 40px 20px;
  background: white;
  border-radius: var(--radius-lg);
  border: 2px dashed var(--gray-300);
  margin: 20px 0;
  grid-column: 1 / -1;
}

.empty i {
  font-size: 36px;
  margin-bottom: 16px;
  color: var(--gray-400);
}

.empty h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 6px;
  color: var(--gray-600);
}

.empty p {
  font-size: 13px;
  color: var(--gray-500);
  max-width: 280px;
  margin: 0 auto;
}

/* POPUPS */
.check-popup,
.delete-confirm-popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  padding: 16px;
  animation: fadeIn 0.2s ease;
}

.check-popup.active,
.delete-confirm-popup.active {
  display: flex;
}

.check-popup-content,
.delete-confirm-content {
  background: white;
  border-radius: var(--radius-md);
  padding: 0;
  max-width: 350px;
  width: 100%;
  text-align: center;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
  border: 2px solid var(--primary);
  position: relative;
  overflow: hidden;
}

.check-popup-content::before,
.delete-confirm-content::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: var(--primary-gradient);
}

.delete-confirm-content {
  border-color: var(--danger);
}

.delete-confirm-content::before {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
}

.check-popup-header,
.delete-confirm-header {
  background: var(--primary-gradient);
  padding: 16px;
  color: white;
  text-align: left;
}

.delete-confirm-header {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
}

.check-popup-title,
.delete-confirm-title {
  font-size: 16px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}

.check-popup-body,
.delete-confirm-body {
  padding: 16px;
}

.delete-confirm-icon {
  font-size: 48px;
  color: var(--danger);
  margin-bottom: 16px;
}

.delete-confirm-message {
  font-size: 14px;
  color: var(--gray-700);
  margin-bottom: 8px;
  line-height: 1.5;
}

.delete-device-name {
  font-weight: 700;
  color: var(--danger-dark);
  background: rgba(239, 68, 68, 0.1);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  display: inline-block;
  margin: 8px 0;
}

.check-popup-footer,
.delete-confirm-footer {
  display: flex;
  gap: 8px;
  padding: 16px;
  border-top: 1px solid var(--gray-200);
}

.popup-btn,
.delete-confirm-btn {
  flex: 1;
  padding: 10px 12px;
  border-radius: var(--radius-sm);
  border: none;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.popup-btn-primary,
.delete-confirm-btn-danger {
  background: var(--primary-gradient);
  color: white;
}

.popup-btn-primary:hover,
.delete-confirm-btn-danger:hover {
  transform: translateY(-2px);
}

.popup-btn-secondary,
.delete-confirm-btn-cancel {
  background: var(--gray-100);
  color: var(--gray-700);
  border: 1px solid var(--gray-300);
}

.popup-btn-secondary:hover,
.delete-confirm-btn-cancel:hover {
  background: var(--gray-200);
  transform: translateY(-2px);
}

.delete-confirm-btn-danger {
  background: linear-gradient(135deg, var(--danger), var(--danger-dark));
}

.online-indicator {
  position: absolute;
  top: 0;
  right: 0;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--success);
  box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
  display: none;
}

.online-indicator.visible {
  display: block;
}

.response-timer {
  background: var(--warning);
  color: white;
  font-size: 9px;
  font-weight: bold;
  padding: 1px 5px;
  border-radius: 6px;
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.load-more-container {
  text-align: center;
  margin: 30px 0 20px;
  padding: 0 16px;
}

.load-more-btn {
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 12px 28px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition-medium);
  border: 1px solid var(--primary-dark);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.load-more-btn:hover {
  background: linear-gradient(135deg, var(--primary-dark), #1e3a8a);
  transform: translateY(-2px);
}

.load-more-btn.loading {
  background: linear-gradient(135deg, var(--warning), #d97706);
  cursor: not-allowed;
  opacity: 0.9;
}

.load-more-count {
  font-size: 12px;
  color: var(--gray-500);
  margin-top: 8px;
  font-weight: 500;
}

/* RESPONSIVE */
@media (max-width: 1024px) {
  .devices {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 14px;
  }
}

@media (max-width: 768px) {
  .header {
    padding: 12px 16px;
  }
  
  .header-title {
    font-size: 18px;
  }
  
  .device-count,
  .active-badge {
    padding: 6px 10px;
    font-size: 11px;
    min-width: auto;
  }
  
  .device-count {
    min-width: 100px;
  }
  
  .active-badge {
    min-width: 130px;
  }
  
  .nav {
    top: 56px;
  }
  
  .nav a {
    padding: 8px 12px;
    font-size: 13px;
  }
  
  .search-bar {
    padding: 14px 16px;
    top: 92px;
  }
  
  .search-bar input {
    padding: 10px 12px 10px 38px;
    font-size: 13px;
  }
  
  .main {
    padding: 0 12px 16px;
  }
  
  .devices {
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 12px;
  }
  
  .device-card {
    height: 155px;
  }
  
  .card-header {
    padding: 8px 12px 5px;
  }
  
  .device-image {
    width: 30px;
    height: 30px;
  }
  
  .serial-badge {
    width: 36px;
    height: 36px;
  }
  
  .like-btn,
  .delete-btn {
    width: 28px;
    height: 28px;
  }
  
  .check-online-btn {
    min-width: 95px;
  }
}

@media (max-width: 480px) {
  .devices {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .device-card {
    height: 150px;
  }
  
  .device-name {
    font-size: 11px;
  }
  
  .serial-badge {
    width: 32px;
    height: 32px;
  }
  
  .check-online-btn {
    min-width: 85px;
  }
  
  .load-more-btn {
    padding: 8px 18px;
    font-size: 12px;
  }
}

::-webkit-scrollbar {
  width: 6px;
  height: 6px;
}

::-webkit-scrollbar-track {
  background: var(--gray-100);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb {
  background: var(--gray-400);
  border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--gray-500);
}
</style>
</head>

<body>

<!-- AUTH ERROR -->
<div id="authError" class="auth-error">
  <h2><i class="fas fa-shield-alt"></i> Authentication Required</h2>
  <p>Your session has expired or you're not authorized to access this page.</p>
  <button class="auth-error-btn" id="authErrorBtn">
    <i class="fas fa-sign-in-alt"></i> Go to Login
  </button>
</div>

<!-- LOADER -->
<div class="fullscreen-loader" id="fullscreenLoader">
  <div class="loader">
    <div class="loader-inner">
      <div class="loader-ring"></div>
      <div class="loader-ring"></div>
      <div class="loader-ring"></div>
      <div class="loader-core"></div>
    </div>
  </div>
  <div class="loading-text">Loading Devices...</div>
</div>

<!-- CHECK POPUP -->
<div class="check-popup" id="checkPopup">
  <div class="check-popup-content">
    <div class="check-popup-header">
      <div class="check-popup-title">
        <i class="fas fa-spinner fa-spin"></i>
        <span id="popupTitleText">Checking device...</span>
      </div>
    </div>
    <div class="check-popup-body">
      <div id="popupMessage">Checking device status...</div>
    </div>
    <div class="check-popup-footer">
      <button class="popup-btn popup-btn-secondary" id="closePopupBtn">
        <i class="fas fa-times"></i>
        Close
      </button>
    </div>
  </div>
</div>

<!-- DELETE CONFIRM POPUP -->
<div class="delete-confirm-popup" id="deleteConfirmPopup">
  <div class="delete-confirm-content">
    <div class="delete-confirm-header">
      <div class="delete-confirm-title">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Confirm Delete</span>
      </div>
    </div>
    <div class="delete-confirm-body">
      <div class="delete-confirm-icon">
        <i class="fas fa-trash-alt"></i>
      </div>
      <div class="delete-confirm-message">
        Are you sure you want to delete this device?
      </div>
      <div class="delete-device-name" id="deleteDeviceName">Device Name</div>
      <div class="delete-confirm-message" style="font-size: 12px; color: var(--gray-500);">
        This action cannot be undone.
      </div>
    </div>
    <div class="delete-confirm-footer">
      <button class="delete-confirm-btn delete-confirm-btn-danger" id="confirmDeleteBtn">
        <i class="fas fa-trash-alt"></i>
        Delete Device
      </button>
      <button class="delete-confirm-btn delete-confirm-btn-cancel" id="cancelDeleteBtn">
        <i class="fas fa-times"></i>
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-title">
      <span class="live">LIVE</span>
    </div>
    
    <div class="top-bar">
      <div class="user-info">
        <div class="device-count" id="totalDevicesBtn">
          <i class="fas fa-mobile-alt"></i>
          Total: <span id="totalDevices">0</span>
        </div>
        <div class="active-badge" id="activeCounterBtn">
          <i class="fas fa-clock"></i>
          Last 15 Min: <span class="active-count" id="activeCount">0</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="status-bar" id="statusBar">
</div>

<!-- NAVIGATION -->
<nav class="nav">
  <div class="nav-container">
    <div class="nav-links">
      <a href="#" onclick="navigateTo('messages.html')">
        <i class="fas fa-comment-alt"></i>
        Messages
      </a>
      <a href="#" onclick="navigateTo('groups.html')">
        <i class="fas fa-layer-group"></i>
        Groups
      </a>
      <a href="devices.html" class="active">
        <i class="fas fa-mobile-alt"></i>
        Devices
      </a>
      <a href="#" onclick="navigateTo('setting.html')">
        <i class="fas fa-cog"></i>
        Settings
      </a>
    </div>
  </div>
</nav>

<!-- SEARCH BAR -->
<div class="search-bar">
  <div class="search-container">
    <i class="fas fa-search"></i>
    <input type="text" id="search" placeholder="Search by device name, model, or phone number...">
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">
  <div class="devices" id="devicesList">
  </div>
  
  <div class="load-more-container" id="loadMoreContainer" style="display: none;">
    <button class="load-more-btn" id="loadMoreBtn">
      <i class="fas fa-plus"></i>
      Load More Devices
    </button>
    <div class="load-more-count" id="loadMoreCount"></div>
  </div>
</div>

<script type="module">
console.log("=== Device Management System Initialized ===");

// Configurations
const API_BASE = "https://webback-production-c9c7.up.railway.app";
const DEVICE_API_PAGINATED = `${API_BASE}/api/devices`;
const SAVE_SERIAL_API = `${API_BASE}/api/device-serial`;
const CHECK_API = `${API_BASE}/api/check-online`;
const BROS_REPLY_API = `${API_BASE}/api/brosreply`;
const DELETE_DEVICE_API = `${API_BASE}/api/delete`;
const LIKE_UNLIKE_API = `${API_BASE}/api/likeunlike`;

// Global State
let allDevices = [];
let checkingDevices = new Map();
let socket = null;
let authToken = null;
let sessionId = null;
let currentDeleteUid = null;

// Pagination
let currentPage = 1;
const DEVICES_PER_PAGE = 20;
let isLoading = false;
let hasMoreDevices = false;
let totalDevicesCount = 0;

// Active devices tracking
let activeDevicesFromSocket = new Map();
let activeDevicesFromAPI = new Map();
let manualCheckStatus = new Map();

// Serial Management - LATEST DEVICE GETS HIGHEST NUMBER SYSTEM
let deviceSerialMap = new Map(); // deviceId -> serialNo (highest for latest)
const DEVICE_SERIALS_KEY = 'device_serials_reverse_system';

// Scroll and state management
let scrollPosition = 0;
let currentFilteredDevices = [];
let currentFilter = 'all';

// ========== CORE FUNCTIONS ==========

function checkAuth() {
  authToken = localStorage.getItem('mr_robot_token');
  sessionId = localStorage.getItem('mr_robot_session_id');
  
  if (!authToken || !sessionId) {
    redirectToLogin();
    return false;
  }
  return true;
}

function redirectToLogin() {
  localStorage.removeItem('mr_robot_token');
  localStorage.removeItem('mr_robot_session_id');
  localStorage.removeItem('mr_robot_userId');
  localStorage.removeItem('mr_robot_active_sessions');
  window.location.href = 'index.html';
}

function showAuthError(message) {
  hideLoader();
  const authError = document.getElementById('authError');
  const authErrorBtn = document.getElementById('authErrorBtn');
  
  if (authError) {
    authError.querySelector('p').textContent = message;
    authError.style.display = 'block';
  }
  
  if (authErrorBtn) {
    authErrorBtn.onclick = redirectToLogin;
  }
}

// Loader Functions
function showLoader() {
  const loader = document.getElementById("fullscreenLoader");
  if (loader) loader.classList.remove("hidden");
}

function hideLoader() {
  const loader = document.getElementById("fullscreenLoader");
  if (loader) {
    setTimeout(() => {
      loader.classList.add("hidden");
    }, 300);
  }
}

// Navigation
function navigateTo(page) {
  console.log(`Navigating to ${page}`);
  saveState();
  window.location.href = page;
}

// State Management
function saveState() {
  const state = {
    scrollPosition: window.scrollY,
    currentPage: currentPage,
    filter: currentFilter,
    search: document.getElementById("search")?.value || '',
    devicesCount: allDevices.length
  };
  sessionStorage.setItem('deviceListState', JSON.stringify(state));
}

function restoreState() {
  const savedState = sessionStorage.getItem('deviceListState');
  if (savedState) {
    const state = JSON.parse(savedState);
    
    // Restore search
    const searchInput = document.getElementById("search");
    if (searchInput && state.search) {
      searchInput.value = state.search;
    }
    
    // Restore filter
    currentFilter = state.filter || 'all';
    updateFilterButtons();
    
    // Render with saved search
    const searchQuery = state.search.toLowerCase() || '';
    renderList(searchQuery);
    
    // Restore scroll position
    setTimeout(() => {
      window.scrollTo(0, state.scrollPosition || 0);
    }, 100);
    
    console.log("State restored:", state);
  }
}

// Serial Management - LATEST DEVICE GETS HIGHEST NUMBER
function initializeSerialSystem() {
  console.log("Initializing reverse serial system (latest gets highest number)...");
  
  // Load from localStorage
  const savedSerials = localStorage.getItem(DEVICE_SERIALS_KEY);
  
  if (savedSerials) {
    try {
      const data = JSON.parse(savedSerials);
      deviceSerialMap = new Map(Object.entries(data.serialMap || {}));
      console.log(`Loaded ${deviceSerialMap.size} device serials from cache`);
    } catch (e) {
      console.error("Error loading serial cache:", e);
    }
  }
}

function saveSerialSystem() {
  try {
    const data = {
      serialMap: Object.fromEntries(deviceSerialMap),
      lastUpdated: Date.now()
    };
    
    localStorage.setItem(DEVICE_SERIALS_KEY, JSON.stringify(data));
    console.log("Serial system saved to localStorage");
  } catch (e) {
    console.error("Error saving serial system:", e);
  }
}

function assignReverseSerial(deviceId, joinTimestamp = Date.now()) {
  // Check if already has serial
  if (deviceSerialMap.has(deviceId)) {
    return deviceSerialMap.get(deviceId);
  }
  
  // If no devices yet, start with 0
  if (deviceSerialMap.size === 0) {
    deviceSerialMap.set(deviceId, 0);
    saveSerialSystem();
    return 0;
  }
  
  // Find the highest current serial number
  let highestSerial = -1;
  for (const serial of deviceSerialMap.values()) {
    if (serial > highestSerial) {
      highestSerial = serial;
    }
  }
  
  // New device gets highest+1 (latest gets highest number)
  const newSerial = highestSerial + 1;
  deviceSerialMap.set(deviceId, newSerial);
  
  saveSerialSystem();
  
  console.log(`Assigned serial ${newSerial} (highest) to ${deviceId}`);
  
  // Save to backend
  saveSerialToBackend(deviceId, newSerial);
  
  return newSerial;
}

async function saveSerialToBackend(deviceId, serialNo) {
  try {
    const response = await fetch(SAVE_SERIAL_API, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        deviceId: deviceId,
        serialNo: serialNo
      })
    });
    
    if (response.ok) {
      console.log(`âœ… Serial ${serialNo} saved to backend for ${deviceId}`);
    }
  } catch (error) {
    console.error("Error saving serial to backend:", error);
  }
}

// Device Processing
function processDevicesForSerials(devices) {
  console.log(`Processing ${devices.length} devices for serial assignment`);
  
  // Sort devices by join timestamp (oldest first) to assign serials correctly
  const sortedByJoin = [...devices].sort((a, b) => {
    const aTime = a.joinedAt || a.installTime || 0;
    const bTime = b.joinedAt || b.installTime || 0;
    return aTime - bTime; // Oldest first
  });
  
  sortedByJoin.forEach(device => {
    const deviceId = device.id || device.uid;
    if (!deviceId) return;
    
    // Assign reverse serial (oldest gets low number, latest gets high number)
    const serialNo = assignReverseSerial(deviceId, device.joinedAt || device.installTime || 0);
    
    // Store in device object
    device.serialNo = serialNo;
  });
}

// Sort devices by serial number DESCENDING (latest/highest on top)
function sortDevicesForDisplay(devices) {
  console.log(`Sorting ${devices.length} devices by serial number (descending - latest on top)`);
  
  return [...devices].sort((a, b) => {
    const aSerial = a.serialNo !== undefined ? a.serialNo : -1;
    const bSerial = b.serialNo !== undefined ? b.serialNo : -1;
    
    // DESCENDING order: highest (latest) first
    return bSerial - aSerial;
  });
}

// Update serials when device is deleted
function updateSerialsAfterDeletion(deletedDeviceId) {
  // Remove the deleted device
  deviceSerialMap.delete(deletedDeviceId);
  
  // Get all device IDs sorted by current serial (ascending)
  const deviceIds = Array.from(deviceSerialMap.keys())
    .sort((a, b) => deviceSerialMap.get(a) - deviceSerialMap.get(b));
  
  // Reassign serials sequentially from 0 to n-1
  deviceIds.forEach((deviceId, index) => {
    deviceSerialMap.set(deviceId, index);
  });
  
  // Update allDevices
  allDevices.forEach(device => {
    const deviceId = device.id || device.uid;
    if (deviceSerialMap.has(deviceId)) {
      device.serialNo = deviceSerialMap.get(deviceId);
    }
  });
  
  saveSerialSystem();
  console.log("Updated serials after deletion - maintaining sequence");
}

// Active Devices Tracking
function getActiveDevices() {
  const now = Date.now();
  const fifteenMinutesAgo = now - (15 * 60 * 1000);
  
  const combined = new Map();
  
  // Add from API
  for (const [uid, deviceData] of activeDevicesFromAPI.entries()) {
    if (deviceData.checkedAt >= fifteenMinutesAgo) {
      combined.set(uid, deviceData);
    }
  }
  
  // Add from Socket
  for (const [uid, socketData] of activeDevicesFromSocket.entries()) {
    if (socketData.checkedAt >= fifteenMinutesAgo) {
      const existing = combined.get(uid);
      if (!existing || socketData.checkedAt > existing.checkedAt) {
        combined.set(uid, socketData);
      }
    }
  }
  
  return combined;
}

function updateActiveBadge() {
  const activeDevices = getActiveDevices();
  const activeCount = activeDevices.size;
  
  const activeCountEl = document.getElementById('activeCount');
  const badge = document.getElementById('activeCounterBtn');
  
  if (activeCountEl) activeCountEl.textContent = activeCount;
  if (badge) badge.classList.toggle('active', activeCount > 0);
  
  return activeCount;
}

// Socket Management
function initSocketListeners() {
  try {
    const socketOptions = {
      transports: ["websocket", "polling"],
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000
    };
    
    if (authToken) {
      socketOptions.query = { token: authToken, sessionId: sessionId };
    }
    
    socket = io(API_BASE, socketOptions);
    
    // Connection events
    socket.on("connect", () => {
      console.log("Socket connected");
      document.getElementById('statusBar').textContent = "System Status: Connected";
      socket.emit("request_checkOnline_all");
    });
    
    socket.on("disconnect", () => {
      console.log("Socket disconnected");
      document.getElementById('statusBar').textContent = "System Status: Disconnected";
    });
    
    socket.on("connect_error", (err) => {
      console.error("Socket connect error:", err);
    });
    
    // Data events
    socket.on("checkOnline_all", (data) => {
      console.log("Socket: checkOnline_all received", data);
      if (data && typeof data === 'object') {
        const now = Date.now();
        const fifteenMinutesAgo = now - (15 * 60 * 1000);
        
        Object.entries(data).forEach(([uid, deviceData]) => {
          if (deviceData && typeof deviceData === 'object') {
            const checkedAt = deviceData.checkedAt || deviceData.timestamp || 0;
            
            if (checkedAt && Number(checkedAt) > fifteenMinutesAgo) {
              activeDevicesFromSocket.set(uid, {
                timestamp: Number(checkedAt),
                checkedAt: Number(checkedAt),
                available: deviceData.available || "",
                source: 'socket_realtime',
                updatedAt: now
              });
            }
          }
        });
        
        updateActiveBadge();
        
        if (currentFilter === 'active') {
          renderList();
        }
      }
    });
    
    socket.on("brosReplyUpdate", (payload) => {
      console.log("Socket: brosReplyUpdate received", payload);
      if (payload && payload.uid && payload.data) {
        const uid = payload.uid;
        const replyData = payload.data;
        const checkedAt = replyData.checkedAt || Date.now();
        
        // Update active devices
        if (replyData.available === "Device is online") {
          const now = Date.now();
          activeDevicesFromSocket.set(uid, {
            timestamp: Number(checkedAt),
            checkedAt: Number(checkedAt),
            available: replyData.available,
            source: 'socket_reply',
            updatedAt: now
          });
          updateActiveBadge();
          
          // Update card status if checking
          updateSingleCardStatus(uid, 'online');
        }
      }
    });
    
    socket.on("newDeviceAdded", (deviceData) => {
      console.log("Socket: newDeviceAdded received", deviceData);
      if (deviceData && deviceData.id) {
        // Assign highest serial number + 1 (latest gets highest)
        const deviceId = deviceData.id;
        
        // Find highest current serial
        let highestSerial = -1;
        for (const serial of deviceSerialMap.values()) {
          if (serial > highestSerial) {
            highestSerial = serial;
          }
        }
        
        const newSerial = highestSerial + 1;
        deviceData.serialNo = newSerial;
        deviceSerialMap.set(deviceId, newSerial);
        saveSerialSystem();
        
        // Save to backend
        saveSerialToBackend(deviceId, newSerial);
        
        // Add to devices array at the beginning (top)
        allDevices.unshift(deviceData);
        totalDevicesCount++;
        
        // Sort devices (latest/highest on top)
        allDevices = sortDevicesForDisplay(allDevices);
        
        // Update UI
        document.getElementById('totalDevices').textContent = totalDevicesCount;
        renderList();
      }
    });
    
    socket.on("deviceDeleted", (data) => {
      console.log("Socket: deviceDeleted received", data);
      if (data && data.uid) {
        // Remove from arrays
        allDevices = allDevices.filter(d => {
          const deviceId = d.id || d.uid;
          return deviceId !== data.uid;
        });
        
        // Update counts
        totalDevicesCount = allDevices.length;
        document.getElementById('totalDevices').textContent = totalDevicesCount;
        
        // Update serials
        updateSerialsAfterDeletion(data.uid);
        
        // Update active devices
        activeDevicesFromSocket.delete(data.uid);
        activeDevicesFromAPI.delete(data.uid);
        updateActiveBadge();
        
        // Re-render
        renderList();
      }
    });
    
    return socket;
  } catch (e) {
    console.error("Error initializing socket:", e);
    return null;
  }
}

// Device Status Management
function updateSingleCardStatus(uid, status) {
  const card = document.querySelector(`.device-card[data-uid="${uid}"]`);
  if (!card) return;

  const button = card.querySelector('.check-online-btn');
  if (!button) return;
  
  button.classList.remove('checking', 'online', 'offline');
  button.disabled = false;
  
  if (status === 'checking') {
    manualCheckStatus.set(uid, { status: 'checking', timestamp: Date.now() });
    button.classList.add('checking');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CHECKING...';
    button.disabled = true;
  } else if (status === 'online') {
    manualCheckStatus.set(uid, { status: 'online', timestamp: Date.now() });
    button.classList.add('online');
    button.innerHTML = '<i class="fas fa-wifi"></i> ONLINE';
    
    // Reset after 30 seconds
    setTimeout(() => {
      if (manualCheckStatus.get(uid)?.status === 'online') {
        resetSingleCardToDefault(uid);
      }
    }, 30000);
  } else if (status === 'offline') {
    manualCheckStatus.set(uid, { status: 'offline', timestamp: Date.now() });
    button.classList.add('offline');
    button.innerHTML = '<i class="fas fa-times"></i> OFFLINE';
    
    // Reset after 10 seconds
    setTimeout(() => {
      if (manualCheckStatus.get(uid)?.status === 'offline') {
        resetSingleCardToDefault(uid);
      }
    }, 10000);
  }
}

function resetSingleCardToDefault(uid) {
  const card = document.querySelector(`.device-card[data-uid="${uid}"]`);
  if (!card) return;
  
  const button = card.querySelector('.check-online-btn');
  if (button) {
    button.classList.remove('online', 'offline', 'checking');
    button.innerHTML = '<i class="fas fa-wifi"></i> CHECK ONLINE';
  }
  
  manualCheckStatus.delete(uid);
}

// Check Online Function
async function checkOnline(uid, event) {
  if (event) event.stopPropagation();
  
  if (checkingDevices.has(uid)) return;
  
  console.log(`Checking online for device: ${uid}`);
  
  updateSingleCardStatus(uid, 'checking');
  checkingDevices.set(uid, { startTime: Date.now() });
  
  // Show popup
  const popup = document.getElementById('checkPopup');
  const popupMessage = document.getElementById('popupMessage');
  if (popup) popup.classList.add('active');
  if (popupMessage) popupMessage.textContent = 'Checking device status...';
  
  try {
    // Send check request
    const timestamp = Date.now();
    await fetch(`${CHECK_API}/${uid}`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${authToken}`
      },
      body: JSON.stringify({ 
        available: "checking",
        timestamp: timestamp
      })
    });
    
    // Check for reply after 5 seconds
    setTimeout(async () => {
      try {
        const response = await fetch(`${BROS_REPLY_API}/${uid}`, {
          headers: { "Authorization": `Bearer ${authToken}` }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.success && result.data) {
            const available = result.data.available || "";
            
            if (available === "Device is online") {
              updateSingleCardStatus(uid, 'online');
              
              // Update active devices
              const now = Date.now();
              activeDevicesFromAPI.set(uid, {
                timestamp: now,
                checkedAt: now,
                available: available,
                source: 'api_check',
                updatedAt: now
              });
              updateActiveBadge();
              
              if (popupMessage) {
                popupMessage.textContent = 'Device is online!';
              }
            } else {
              updateSingleCardStatus(uid, 'offline');
              if (popupMessage) {
                popupMessage.textContent = 'Device is offline';
              }
            }
          } else {
            updateSingleCardStatus(uid, 'offline');
            if (popupMessage) {
              popupMessage.textContent = 'Device not responding';
            }
          }
        } else {
          updateSingleCardStatus(uid, 'offline');
          if (popupMessage) {
            popupMessage.textContent = 'Error checking device';
          }
        }
      } catch (error) {
        console.error("Error checking reply:", error);
        updateSingleCardStatus(uid, 'offline');
        if (popupMessage) {
          popupMessage.textContent = 'Network error';
        }
      }
    }, 5000);
    
  } catch (error) {
    console.error("Error in checkOnline:", error);
    updateSingleCardStatus(uid, 'offline');
    if (popupMessage) {
      popupMessage.textContent = 'Network error';
    }
  } finally {
    checkingDevices.delete(uid);
  }
}

// Delete Device
function showDeleteConfirm(uid, deviceName) {
  currentDeleteUid = uid;
  const deleteDeviceName = document.getElementById('deleteDeviceName');
  if (deleteDeviceName) {
    deleteDeviceName.textContent = deviceName || 'Unknown Device';
  }
  const popup = document.getElementById('deleteConfirmPopup');
  if (popup) popup.classList.add('active');
}

function hideDeleteConfirm() {
  const popup = document.getElementById('deleteConfirmPopup');
  if (popup) popup.classList.remove('active');
  currentDeleteUid = null;
}

async function deleteDevice(uid) {
  try {
    showLoader();
    
    const response = await fetch(`${DELETE_DEVICE_API}/${uid}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.status === 401 || response.status === 403) {
      redirectToLogin();
      return;
    }
    
    const data = await response.json();
    
    if (data.success) {
      // Remove from all arrays
      allDevices = allDevices.filter(device => {
        const deviceId = device.id || device.uid;
        return deviceId !== uid;
      });
      
      // Update counts
      totalDevicesCount = allDevices.length;
      document.getElementById('totalDevices').textContent = totalDevicesCount;
      
      // Remove from active devices
      activeDevicesFromSocket.delete(uid);
      activeDevicesFromAPI.delete(uid);
      manualCheckStatus.delete(uid);
      updateActiveBadge();
      
      // Update serials to maintain sequence
      updateSerialsAfterDeletion(uid);
      
      hideLoader();
      hideDeleteConfirm();
      
      // Re-render
      renderList();
      
      // Emit socket event
      if (socket && socket.connected) {
        socket.emit('deviceDeleted', { uid: uid });
      }
    }
  } catch (error) {
    console.error("Error deleting device:", error);
    hideLoader();
  }
}

// Like/Unlike
async function toggleLike(uid, event) {
  if (event) event.stopPropagation();
  
  const device = allDevices.find(d => {
    const deviceId = d.id || d.uid;
    return deviceId === uid;
  });
  
  if (!device) return;
  
  const isLiked = device.likedByUser || false;
  const newLikeStatus = !isLiked;
  
  device.likedByUser = newLikeStatus;
  updateLikeUI(uid, newLikeStatus);
  
  try {
    const response = await fetch(LIKE_UNLIKE_API, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ uid: uid })
    });
    
    if (response.ok) {
      const data = await response.json();
      device.likedByUser = data.liked || newLikeStatus;
      updateLikeUI(uid, data.liked || newLikeStatus);
    }
  } catch (error) {
    console.error("Error toggling like:", error);
    device.likedByUser = isLiked;
    updateLikeUI(uid, isLiked);
  }
}

function updateLikeUI(uid, isLiked) {
  const card = document.querySelector(`.device-card[data-uid="${uid}"]`);
  if (!card) return;
  
  const likeBtn = card.querySelector('.like-btn');
  if (likeBtn) {
    if (isLiked) {
      likeBtn.classList.add('liked');
      likeBtn.innerHTML = '<i class="fas fa-heart"></i>';
    } else {
      likeBtn.classList.remove('liked');
      likeBtn.innerHTML = '<i class="far fa-heart"></i>';
    }
  }
}

// Utility Functions
function getDisplaySimInfo(device) {
  let simNumber = "";
  let simCarrier = "";
  
  if (device.sim2Number && device.sim2Number !== "Unknown") {
    simNumber = device.sim2Number;
    simCarrier = device.sim2Carrier || device.simOperator || "Unknown";
  } else if (device.sim1Number && device.sim1Number !== "Unknown") {
    simNumber = device.sim1Number;
    simCarrier = device.sim1Carrier || device.simOperator || "Unknown";
  } else {
    simNumber = "No SIM";
    simCarrier = "";
  }
  
  return { simNumber, simCarrier };
}

function formatTime(timestamp) {
  if (!timestamp || timestamp === "0" || timestamp === 0) return "Never";
  
  const date = new Date(Number(timestamp));
  if (isNaN(date.getTime())) return "Never";
  
  const now = new Date();
  const diffMs = now - date;
  const diffSecs = Math.floor(diffMs / 1000);
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffSecs < 60) return `${diffSecs} sec ago`;
  if (diffMins < 60) return `${diffMins} min ago`;
  if (diffHours < 24) return `${diffHours} hours ago`;
  if (diffDays < 30) return `${diffDays} days ago`;
  
  return date.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

function formatDateOnly(timestamp) {
  if (!timestamp || timestamp === "0" || timestamp === 0) return "Unknown";
  
  const date = new Date(Number(timestamp));
  if (isNaN(date.getTime())) return "Unknown";
  
  return date.toLocaleDateString('en-GB', {
    day: '2-digit',
    month: 'short',
    year: 'numeric'
  });
}

// Render Device Card
function renderDevice(device) {
  const uid = device.id || device.uid;
  const brand = device.brand || "Unknown";
  const model = device.model || "";
  const androidVersion = device.androidVersion || "";
  const isLiked = device.likedByUser || false;
  
  const simInfo = getDisplaySimInfo(device);
  const joinedDate = formatDateOnly(device.joinedAt || device.installTime || 0);
  const lastSeen = formatTime(device.lastSeen);
  
  // Get serial number (highest for latest devices)
  const serialNo = device.serialNo !== undefined ? device.serialNo : 0;
  
  // Get button status
  const manualStatus = manualCheckStatus.get(uid);
  let buttonStatus = '';
  let buttonText = '';
  let isDisabled = false;
  
  if (manualStatus?.status === 'checking') {
    buttonStatus = 'checking';
    buttonText = '<i class="fas fa-spinner fa-spin"></i> CHECKING...';
    isDisabled = true;
  } else if (manualStatus?.status === 'online') {
    buttonStatus = 'online';
    buttonText = '<i class="fas fa-wifi"></i> ONLINE';
  } else if (manualStatus?.status === 'offline') {
    buttonStatus = 'offline';
    buttonText = '<i class="fas fa-times"></i> OFFLINE';
  } else {
    buttonText = '<i class="fas fa-wifi"></i> CHECK ONLINE';
  }
  
  const card = document.createElement("div");
  card.className = "device-card";
  card.setAttribute('data-uid', uid);
  
  card.innerHTML = `
    <div class="top-buttons-container">
      <div class="serial-badge" title="Serial ${serialNo} (${serialNo === totalDevicesCount-1 ? 'Latest' : serialNo === 0 ? 'Oldest' : ''})">
        <div class="serial-text">${serialNo}</div>
      </div>
      <button class="like-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${uid}', event)">
        ${isLiked ? '<i class="fas fa-heart"></i>' : '<i class="far fa-heart"></i>'}
      </button>
      <button class="delete-btn" onclick="showDeleteConfirm('${uid}', '${brand} ${model}'.replace(/'/g, "\\'"))">
        <i class="fas fa-trash-alt"></i>
      </button>
    </div>
    
    <div class="card-header">
      <img src="./assets/image/android.png" alt="Device" class="device-image">
      
      <div class="device-info">
        <div class="device-name-row">
          <div class="device-name" title="${brand} ${model}">${brand} ${model}</div>
          <div class="device-version">
            ${androidVersion ? `Version ${androidVersion}` : ''}
          </div>
        </div>
      </div>
    </div>
    
    <div class="sim-info">
      <div class="sim-header">
        <i class="fas fa-sim-card"></i>
        <div class="sim-details">
          <div class="sim-number">${simInfo.simNumber}</div>
          ${simInfo.simCarrier ? `<div class="sim-carrier">${simInfo.simCarrier}</div>` : ''}
        </div>
      </div>
      
      <div class="time-info">
        <div class="time-item">
          <i class="fas fa-calendar-plus"></i>
          <div class="time-text">
            <span class="time-label">Joined:</span>
            ${joinedDate}
          </div>
        </div>
        
        <div class="time-item">
          <i class="fas fa-clock"></i>
          <div class="time-text">
            <span class="time-label">Last Seen:</span>
            ${lastSeen}
          </div>
        </div>
      </div>
    </div>
    
    <div class="card-footer">
      <div class="device-id" title="${uid}">${uid ? uid.substring(0, 10) + '...' : 'N/A'}</div>
      <button class="check-online-btn ${buttonStatus}" 
              onclick="checkOnline('${uid}', event)"
              ${isDisabled ? 'disabled' : ''}>
        ${buttonText}
      </button>
    </div>
  `;

  card.onclick = (e) => {
    if (!e.target.closest('.top-buttons-container') && 
        !e.target.closest('.check-online-btn')) {
      saveState();
      location.href = `device-details.html?id=${uid}`;
    }
  };
  
  return card;
}

// Fetch Devices with Caching
async function fetchDevices(isLoadMore = false) {
  if (isLoading) return;
  
  if (!isLoadMore) {
    showLoader();
    isLoading = true;
    currentPage = 1;
  } else {
    currentPage++;
  }
  
  try {
    const endpoint = `${DEVICE_API_PAGINATED}?page=${currentPage}&limit=${DEVICES_PER_PAGE}`;
    console.log(`Fetching from: ${endpoint}`);
    
    const response = await fetch(endpoint, {
      headers: { 
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      }
    });
    
    if (response.status === 401 || response.status === 403) {
      showAuthError('Session expired. Please login again.');
      return;
    }
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    const devices = data.data || [];
    
    console.log(`Received ${devices.length} devices`);
    
    if (!isLoadMore) {
      // Initialize serial system
      initializeSerialSystem();
      
      // Process devices for serials (oldest gets low number, latest gets high number)
      processDevicesForSerials(devices);
      
      // Sort by serial number DESCENDING (latest/highest on top)
      allDevices = sortDevicesForDisplay(devices);
      totalDevicesCount = data.total || devices.length;
      
      // Update UI
      document.getElementById('totalDevices').textContent = totalDevicesCount;
      
      // Render
      const searchQuery = document.getElementById("search")?.value.toLowerCase() || '';
      renderList(searchQuery);
      
      // Check pagination
      hasMoreDevices = data.pagination?.hasNext || false;
      updateLoadMoreButton(data.pagination);
      
      // Hide loader after a short delay
      setTimeout(() => {
        hideLoader();
        isLoading = false;
      }, 500);
      
    } else {
      // Process new devices
      processDevicesForSerials(devices);
      
      // Merge and sort
      const mergedDevices = [...allDevices, ...devices];
      allDevices = sortDevicesForDisplay(mergedDevices);
      
      // Update UI
      const searchQuery = document.getElementById("search")?.value.toLowerCase() || '';
      renderList(searchQuery);
      
      // Check pagination
      hasMoreDevices = data.pagination?.hasNext || false;
      updateLoadMoreButton(data.pagination);
      
      isLoading = false;
    }
    
  } catch (error) {
    console.error('Error fetching devices:', error);
    hideLoader();
    isLoading = false;
    
    // Show error
    const devicesList = document.getElementById("devicesList");
    if (devicesList) {
      devicesList.innerHTML = `
        <div class="empty">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Error Loading Devices</h3>
          <p>Please check your connection and try again</p>
        </div>
      `;
    }
  }
}

// Render List
function renderList(searchQuery = '') {
  const q = searchQuery || (document.getElementById("search")?.value.toLowerCase() || '');
  const container = document.getElementById("devicesList");
  
  if (!container) return;
  
  // Clear container
  container.innerHTML = "";
  
  // Filter devices
  let filteredDevices = allDevices.filter(device => {
    const searchStr = `
      ${device.brand || ''}
      ${device.model || ''}
      ${device.sim1Number || ''}
      ${device.sim2Number || ''}
      ${device.id || ''}
      ${device.uid || ''}
    `.toLowerCase();
    
    return searchStr.includes(q);
  });
  
  // Apply active filter if needed
  if (currentFilter === 'active') {
    const activeDevices = getActiveDevices();
    const activeUids = Array.from(activeDevices.keys());
    filteredDevices = filteredDevices.filter(device => {
      const deviceId = device.id || device.uid;
      return activeUids.includes(deviceId);
    });
  }
  
  currentFilteredDevices = filteredDevices;
  
  // Show message if no devices
  if (filteredDevices.length === 0) {
    container.innerHTML = `
      <div class="empty">
        <i class="fas fa-search"></i>
        <h3>No devices found</h3>
        <p>${currentFilter === 'active' ? 'No active devices' : 'Try a different search term'}</p>
      </div>
    `;
    document.getElementById('loadMoreContainer').style.display = 'none';
    return;
  }
  
  // Render devices
  filteredDevices.forEach(device => {
    const card = renderDevice(device);
    container.appendChild(card);
  });
  
  updateLoadMoreButton();
}

// Load More
function loadMoreDevices() {
  if (isLoading || !hasMoreDevices) return;
  
  console.log('Loading more devices...');
  fetchDevices(true);
}

function updateLoadMoreButton(pagination = null) {
  const loadMoreContainer = document.getElementById('loadMoreContainer');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const loadMoreCount = document.getElementById('loadMoreCount');
  
  if (!loadMoreContainer || !loadMoreBtn || !loadMoreCount) return;
  
  if (pagination) {
    hasMoreDevices = pagination.hasNext || false;
  }
  
  if (hasMoreDevices) {
    loadMoreContainer.style.display = 'block';
    loadMoreCount.textContent = `Loaded ${allDevices.length} of ${totalDevicesCount} devices`;
    
    if (isLoading) {
      loadMoreBtn.classList.add('loading');
      loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
      loadMoreBtn.disabled = true;
    } else {
      loadMoreBtn.classList.remove('loading');
      loadMoreBtn.innerHTML = '<i class="fas fa-plus"></i> Load More Devices';
      loadMoreBtn.disabled = false;
    }
  } else {
    loadMoreContainer.style.display = 'none';
  }
}

// Filter Functions
function updateFilterButtons() {
  const totalBtn = document.getElementById('totalDevicesBtn');
  const activeBtn = document.getElementById('activeCounterBtn');
  
  if (totalBtn) {
    totalBtn.classList.toggle('active-filter', currentFilter === 'all');
  }
  
  if (activeBtn) {
    activeBtn.classList.toggle('active-filter', currentFilter === 'active');
  }
}

function setFilter(filterType) {
  if (currentFilter === filterType) return;
  
  currentFilter = filterType;
  updateFilterButtons();
  renderList();
  updateLoadMoreButton();
}

// Initialize Event Listeners
function initEventListeners() {
  // Filter buttons
  const totalBtn = document.getElementById('totalDevicesBtn');
  const activeBtn = document.getElementById('activeCounterBtn');
  
  if (totalBtn) totalBtn.addEventListener('click', () => setFilter('all'));
  if (activeBtn) activeBtn.addEventListener('click', () => setFilter('active'));
  
  // Load more button
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  if (loadMoreBtn) loadMoreBtn.addEventListener('click', loadMoreDevices);
  
  // Search input
  const searchInput = document.getElementById("search");
  let searchTimer;
  
  if (searchInput) {
    searchInput.addEventListener("input", function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        renderList();
      }, 300);
    });
  }
  
  // Popup close buttons
  const closePopupBtn = document.getElementById('closePopupBtn');
  const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
  
  if (closePopupBtn) closePopupBtn.onclick = () => {
    document.getElementById('checkPopup').classList.remove('active');
  };
  
  if (cancelDeleteBtn) cancelDeleteBtn.onclick = hideDeleteConfirm;
  
  if (confirmDeleteBtn) confirmDeleteBtn.onclick = () => {
    if (currentDeleteUid) {
      deleteDevice(currentDeleteUid);
    }
  };
  
  // Auth error button
  const authErrorBtn = document.getElementById('authErrorBtn');
  if (authErrorBtn) authErrorBtn.onclick = redirectToLogin;
  
  // Popup background click
  const checkPopup = document.getElementById('checkPopup');
  const deletePopup = document.getElementById('deleteConfirmPopup');
  
  if (checkPopup) {
    checkPopup.addEventListener('click', function(e) {
      if (e.target === this) {
        this.classList.remove('active');
      }
    });
  }
  
  if (deletePopup) {
    deletePopup.addEventListener('click', function(e) {
      if (e.target === this) {
        hideDeleteConfirm();
      }
    });
  }
}

// Main Initialization
document.addEventListener('DOMContentLoaded', async function() {
  console.log("Device Manager Initializing...");
  
  // Check authentication
  if (!checkAuth()) {
    return;
  }

  initEventListeners();
  
  socket = initSocketListeners();
  
  // Load initial data
  await fetchDevices(false);
  
  // Restore state (for back navigation)
  restoreState();
  
  // Periodic refresh (every 2 minutes)
  setInterval(() => {
    if (document.visibilityState === 'visible') {
      console.log("Periodic refresh...");
      fetchDevices(false);
    }
  }, 120000);
  
  console.log("Device Manager Initialized Successfully");
});

window.toggleLike = toggleLike;
window.showDeleteConfirm = showDeleteConfirm;
window.checkOnline = checkOnline;
window.navigateTo = navigateTo;
</script>
</body>
</html>